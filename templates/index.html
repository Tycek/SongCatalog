{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-3">My Song Collection</h2>
<p class="text-muted mb-4">Manage and organize your favorite songs with ease</p>

<!-- Dashboard Stats -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="stat-card">
      <div class="icon bg-primary"><i class="bi bi-music-note-list"></i></div>
      <div>
        <h4 class="fw-bold">{{ songs|length }}</h4>
        <p class="text-muted mb-0">Total Songs</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="icon bg-purple"><i class="bi bi-person-lines-fill"></i></div>
      <div>
        <h4 class="fw-bold">{{ songs|map(attribute='artist')|unique|list|length }}</h4>
        <p class="text-muted mb-0">Artists</p>
      </div>
    </div>
  </div>

  <!--<div class="col-md-3">
    <div class="stat-card">
      <div class="icon bg-pink"><i class="bi bi-heart-fill"></i></div>
      <div>
        <h4 class="fw-bold">—</h4>
        <p class="text-muted mb-0">Favorites</p>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="stat-card">
      <div class="icon bg-yellow"><i class="bi bi-collection"></i></div>
      <div>
        <h4 class="fw-bold">—</h4>
        <p class="text-muted mb-0">Collections</p>
      </div>
    </div>
  </div> -->
</div>

<!-- Filters -->
<form id="filtersForm" method="get" action="{{ url_for('index') }}" class="filter-bar shadow-sm bg-white p-3 rounded-4 d-flex align-items-center mb-4">
  <input type="hidden" name="search" value="{{ request.args.get('search', '') }}">

  <div class="me-3">
    <label class="text-muted small fw-bold">Genre:</label>
    <select name="genre" class="form-select form-select-sm rounded-3" onchange="this.form.submit()">
      <option value="" {% if not selected_genre %}selected{% endif %}>All Genres</option>
      {% for g in genres %}
        <option value="{{ g }}" {% if g == selected_genre %}selected{% endif %}>{{ g }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label class="text-muted small fw-bold">Tuning:</label>
    <select name="tuning" class="form-select form-select-sm rounded-3" onchange="this.form.submit()">
      <option value="" {% if not selected_tuning %}selected{% endif %}>All Tunings</option>
      {% for t in tunings %}
        <option value="{{ t }}" {% if t == selected_tuning %}selected{% endif %}>{{ t }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="ms-auto d-flex gap-2">
    <button type="button" id="clearFilters" class="btn btn-outline-secondary btn-sm rounded-4">
      <i class="bi bi-funnel"></i> Clear
    </button>
    <button type="submit" class="btn btn-outline-secondary btn-sm rounded-4"><i class="bi bi-sort-down"></i> Apply</button>
  </div>
</form>

<script>
  document.getElementById('clearFilters').addEventListener('click', function() {
    window.location.href = "{{ url_for('index') }}";
  });
</script>
</form>

<!-- Table -->
<div class="table-responsive bg-white shadow-sm p-3 rounded-4">
  <table class="table align-middle">
    <thead>
      <tr class="text-muted small">
        <th>Song Name</th>
        <th>Artist</th>
        <th>Genre</th>
        <th>Tuning</th>
        <th>Resources</th>
        <th>Notes</th>
        <th class="text-end">Actions</th>
      </tr>
    </thead>

    <tbody>
    {% for song in songs %}
      <tr>
        <td class="fw-semibold">
          <i class="bi bi-music-note icon-color"></i> {{ song['name'] }}
        </td>

        <td>{{ song['artist'] }}</td>

        <td>
          {% if song['genre'] %}
            <span class="badge genre-badge">{{ song['genre'] }}</span>
          {% endif %}
        </td>

        <td>{{ song['tuning'] }}</td>

        <td>
          {% if song['link'] %}
            <a href="{{ song['link'] }}" class="me-2" target="_blank"><i class="bi bi-file-earmark-music"></i> Chords</a>
          {% endif %}
        </td>

        <td class="text-muted small">{{ song['note'] }}</td>

        <td class="text-end">
          <button class="btn btn-sm btn-danger rounded-3"
                  data-bs-toggle="modal"
                  data-bs-target="#deleteModal"
                  data-song-id="{{ song['id'] }}"
                  data-song-name="{{ song['name'] }}">
            <i class="bi bi-trash"></i>
          </button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4">
      <div class="modal-header">
        <h5 class="modal-title">Delete Song</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p id="deleteSongName"></p>
        <form id="deleteForm" method="post">
          <input type="password" name="password"
                 class="form-control mb-3" placeholder="Enter password" required>
          <button class="btn btn-danger w-100 rounded-4">Confirm</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
const deleteModal = document.getElementById("deleteModal");
deleteModal.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    const songId = button.getAttribute("data-song-id");
    const songName = button.getAttribute("data-song-name");
    document.getElementById("deleteSongName").textContent =
        `Are you sure you want to delete "${songName}"?`;
    document.getElementById("deleteForm").action = `/delete/${songId}`;
});
</script>
{% endblock %}
